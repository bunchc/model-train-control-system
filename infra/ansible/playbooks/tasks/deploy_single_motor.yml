---
# Deploy a single motor's edge controller container
# This task file is included by deploy_edge_multi_motor.yml

# ========================================================================
# Generate UUID if not provided
# ========================================================================

- name: Generate UUID for motor M{{ motor.motor_port }} if not defined
  set_fact:
    motor_train_id: "{{ motor.train_id | default(lookup('community.general.random_string', length=32, base64=False) | to_uuid) }}"

# ========================================================================
# Create Motor-Specific Configuration
# ========================================================================

- name: Create configuration for motor M{{ motor.motor_port }}
  copy:
    dest: "/opt/train-control/config/edge-controller-m{{ motor.motor_port }}.conf"
    content: |
      # Edge Controller Configuration for Motor M{{ motor.motor_port }}
      # Generated by Ansible on {{ ansible_date_time.iso8601 }}

      central_api_host: {{ central_api_host }}
      central_api_port: {{ central_api_port }}

      mqtt_broker:
        host: {{ mqtt_broker }}
        port: {{ mqtt_port }}
        username: {{ mqtt_username }}
        password: {{ mqtt_password }}

      train_id: {{ motor_train_id }}
      train_name: {{ motor.train_name }}
      motor_port: {{ motor.motor_port }}
      hardware_type: {{ hardware_type | default('dc_motor') }}
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

# ========================================================================
# Deploy Container for This Motor
# ========================================================================

- name: Stop existing container for motor M{{ motor.motor_port }}
  docker_container:
    name: "{{ motor.container_name }}"
    state: stopped
  failed_when: false

- name: Remove existing container for motor M{{ motor.motor_port }}
  docker_container:
    name: "{{ motor.container_name }}"
    state: absent
  failed_when: false

- name: Deploy edge controller container for motor M{{ motor.motor_port }}
  docker_container:
    name: "{{ motor.container_name }}"
    image: "{{ edge_image_full }}"
    state: started
    restart_policy: unless-stopped

    # Privileged mode for I2C/GPIO access (required for DC motors)
    privileged: "{{ hardware_type | default('dc_motor') != 'simulator' }}"

    # Device mapping for GPIO and I2C
    devices: >-
      {{
        ['/dev/gpiomem:/dev/gpiomem', '/dev/i2c-1:/dev/i2c-1']
        if hardware_type | default('dc_motor') != 'simulator'
        else []
      }}

    # Volumes
    volumes:
      - "/opt/train-control/config/edge-controller-m{{ motor.motor_port }}.conf:/app/edge-controller.conf:ro"
      - "/opt/train-control/logs:/app/logs"
      - "/var/lib/train-control/m{{ motor.motor_port }}:/app/data"

    # Environment variables
    env:
      TRAIN_ID: "{{ motor_train_id }}"
      TRAIN_NAME: "{{ motor.train_name }}"
      HARDWARE_TYPE: "{{ hardware_type | default('dc_motor') }}"
      MOTOR_PORT: "{{ motor.motor_port | string }}"
      MQTT_BROKER: "{{ mqtt_broker }}"
      MQTT_PORT: "{{ mqtt_port | string }}"
      MQTT_USERNAME: "{{ mqtt_username }}"
      MQTT_PASSWORD: "{{ mqtt_password }}"
      CENTRAL_API_URL: "{{ central_api_url }}"
      LOG_LEVEL: "{{ log_level | default('INFO') }}"
      SIMULATION_MODE: "{{ simulation_mode | default('false') | string }}"

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Labels
    labels:
      train_id: "{{ motor_train_id }}"
      motor_port: "M{{ motor.motor_port }}"
      component: edge-controller
      managed_by: ansible
  register: container_result

# ========================================================================
# Validation
# ========================================================================

- name: Wait for container M{{ motor.motor_port }} to start
  command: "docker inspect --format='{% raw %}{{.State.Running}}{% endraw %}' {{ motor.container_name }}"
  register: container_running
  until: container_running.stdout == 'true'
  retries: 5
  delay: 2
  changed_when: false

- name: Get container logs for M{{ motor.motor_port }} (last 10 lines)
  command: docker logs --tail 10 {{ motor.container_name }}
  register: motor_logs
  changed_when: false

- name: Show deployment result for motor M{{ motor.motor_port }}
  debug:
    msg:
      - "âœ“ Motor M{{ motor.motor_port }} deployed: {{ motor.train_name }}"
      - "  Container: {{ motor.container_name }}"
      - "  Train ID: {{ motor_train_id }}"
      - "  Status Topic: trains/{{ motor_train_id }}/status"
      - "  Commands Topic: trains/{{ motor_train_id }}/commands"
