---
- name: Provision edge-controller for test environment
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Generate train UUID for test
      set_fact:
        train_uuid: "{{ lookup('community.general.random_string', length=32, base64=False) | to_uuid }}"

    - name: Create edge-controller config for test
      copy:
        dest: "{{ playbook_dir }}/../../../.tmp/edge-controller.conf"
        content: |
          # Edge Controller Configuration for Test
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          central_api_host: {{ central_api_host | default('central_api') }}
          central_api_port: {{ central_api_port | default(8000) }}

          mqtt_broker:
            host: {{ mqtt_broker | default('localhost') }}
            port: {{ mqtt_port | default(18884) }}
            username: {{ mqtt_username | default('test') }}
            password: {{ mqtt_password | default('test') }}

          trains:
            - id: {{ train_uuid }}
              name: {{ train_name | default('Test Train') }}
              motor_port: {{ motor_port | default(1) }}
              hardware_type: {{ hardware_type | default('simulator') }}
              mqtt_topic: trains/{{ train_uuid }}/status
              config_path: /app/edge-controller.conf
              status_topic: trains/{{ train_uuid }}/status
              commands_topic: trains/{{ train_uuid }}/commands
    - name: Inject mock secrets (if needed)
      copy:
        content: "MQTT_USER=test\nMQTT_PASS=test"
        dest: "{{ playbook_dir }}/../../../.tmp/edge-controller.secrets"
      when: false  # Set to true if secrets are required
    # Add any other setup steps needed for test provisioning
