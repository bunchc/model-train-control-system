---
- name: Provision edge-controller for test environment
  hosts: localhost
  gather_facts: true
  tasks:
    - name: Choose random motor port (m1-m4)
      set_fact:
        motor_port: "m{{ (1 + (99999999 * ansible_date_time.epoch | int + ansible_date_time.time | int) % 4) }}"

    - name: Generate random RFC1918 address
      set_fact:
        controller_address: "{{ ['10', '172', '192'] | random }}.{{ 16 + (99999999 * ansible_date_time.epoch | int + 1) % 64 }}.{{ 1 + (99999999 * ansible_date_time.epoch | int + 2) % 254 }}.{{ 1 + (99999999 * ansible_date_time.epoch | int + 3) % 254 }}"

    - name: Generate random 2-3 word phrase for controller name
      set_fact:
        controller_name: "{{ lookup('community.general.random_words', count=(2 + (99999999 * ansible_date_time.epoch | int + 4) % 2), separator=' ') | title }} Controller"
    - name: Generate controller UUID for test
      set_fact:
        controller_uuid: "{{ lookup('community.general.random_string', length=32, base64=False) | to_uuid }}"
    - name: Generate train UUID for test
      set_fact:
        train_uuid: "{{ lookup('community.general.random_string', length=32, base64=False) | to_uuid }}"

    - name: Create edge-controller config for test
      copy:
        dest: "{{ playbook_dir }}/../../../.tmp/edge-controller.conf"
        content: |
          # Edge Controller Configuration for Test
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          controller_name: {{ controller_name }}

          central_api_host: {{ central_api_host | default('central_api') }}
          central_api_port: {{ central_api_port | default(8000) }}

          mqtt_broker:
            host: {{ mqtt_broker | default('localhost') }}
            port: {{ mqtt_port | default(18884) }}
            username: {{ mqtt_username | default('test') }}
            password: {{ mqtt_password | default('test') }}

          trains:
            - id: {{ train_uuid }}
              name: {{ train_name | default('Test Train') }}
              motor_port: {{ motor_port | default(1) }}
              hardware_type: {{ hardware_type | default('simulator') }}
              mqtt_topic: trains/{{ train_uuid }}/status
              config_path: /app/edge-controller.conf
              status_topic: trains/{{ train_uuid }}/status
              commands_topic: trains/{{ train_uuid }}/commands
    - name: Generate config.test.yaml for test
      copy:
        dest: "{{ playbook_dir }}/../../../.tmp/config.test.yaml"
        content: |
          # Edge Controller Configuration for Test
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          # -----------------------------------------------------------------
          # PLUGIN DEFINITIONS
          #
          # Master library of all available plugins.
          # An edge controller will load any plugin
          # referenced by one of its child trains.
          # -----------------------------------------------------------------

          plugins:
            - name: stepper_hat
              description: |
                uGeek Stepper Motor Hat v0.2
                Uses PWM to control track voltage and drive stepper motors.
              config:
                required:
                  - "port"
                properties:
                  i2c_address: {{ i2c_address | default('0x6F') }}
                  port: {{ motor_port | default(1) }}
                  default_speed: {{ default_speed | default(50) }}
                  enabled: {{ plugin_enabled | default(true) }}

          edge_controllers:
            - id: {{ controller_uuid }}
              address: {{ controller_address }}
              enabled: {{ controller_enabled | default(true) }}
              name: {{ controller_name }}
              description: |
                {{ controller_description | default('Durango Silverton and Silver Streak Trains') }}
              trains:
                - name: {{ train_name | default('Durango Silverton') }}
                  description: |
                    {{ train_description | default('n Scale model of Durango Silverton from Bachman') }}
                  id: {{ train_uuid }}
                  model: {{ train_model | default('American Locomotive Works K-28') }}
                  plugin:
                    name: {{ plugin_name | default('stepper_hat') }}
                    config:
                      port: {{ motor_port }}
                      default_speed: {{ default_speed | default(75) }}
    - name: Inject mock secrets (if needed)
      copy:
        content: "MQTT_USER=test\nMQTT_PASS=test"
        dest: "{{ playbook_dir }}/../../../.tmp/edge-controller.secrets"
      when: false  # Set to true if secrets are required
    # Add any other setup steps needed for test provisioning
