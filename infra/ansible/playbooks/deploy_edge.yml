---
# Deploy Edge Controllers to Raspberry Pi Devices
#
# This playbook deploys edge-controller containers to RPi devices
#
# Usage:
#   ansible-playbook playbooks/deploy_edge.yml --ask-vault-pass
#   ansible-playbook playbooks/deploy_edge.yml --limit rpi-train-01
#   ansible-playbook playbooks/deploy_edge.yml --tags update  # Update only

- name: Deploy Edge Controllers
  hosts: edge
  become: true
  gather_facts: true

  vars_files:
    - ../secrets/vault.yml

  vars:
    edge_container_name: edge-controller
    edge_image_full: "{{ edge_controller_image }}:{{ edge_controller_tag }}"

  pre_tasks:
    # ========================================================================
    # Generate UUID for train_id if not defined
    # ========================================================================

    - name: Check if train_id is already defined in inventory
      set_fact:
        train_id_needs_generation: "{{ train_id is not defined }}"

    - name: Generate UUID for train_id
      set_fact:
        train_id: "{{ lookup('password', '/dev/null length=16 chars=hexdigits') | to_uuid }}"
      when: train_id_needs_generation | bool

    - name: Display generated train_id
      debug:
        msg: "Using train_id: {{ train_id }} ({{ 'auto-generated' if train_id_needs_generation | bool else 'from inventory' }})"

    - name: Save generated train_id to inventory
      lineinfile:
        path: "{{ inventory_dir }}/hosts.yml"
        regexp: "^(\\s*)# train_id:.*$"
        line: "\\1train_id: {{ train_id }}  # Auto-generated by Ansible"
        backrefs: yes
      become: no
      delegate_to: localhost
      when: train_id_needs_generation | bool

    # ========================================================================
    # Verify Dependencies
    # ========================================================================

    - name: Verify Docker is installed
      command: docker --version
      register: docker_check
      failed_when: docker_check.rc != 0
      changed_when: false

    - name: Verify central API is reachable
      uri:
        url: "{{ central_api_url }}/api/ping"
        timeout: 5
      register: api_check
      failed_when: api_check.status != 200
      retries: 3
      delay: 5

  tasks:
    # ========================================================================
    # Prepare Edge Environment
    # ========================================================================

    - name: Create edge controller configuration directory
      file:
        path: /opt/train-control/config
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Create edge controller configuration file
      copy:
        dest: /opt/train-control/config/edge-controller.conf
        content: |
          # Edge Controller Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          [DEFAULT]
          train_id = {{ train_id }}
          train_name = {{ train_name }}

          [mqtt]
          broker = {{ mqtt_broker }}
          port = {{ mqtt_port }}
          username = {{ mqtt_username }}
          password = {{ mqtt_password }}
          topic_prefix = trains/{{ train_id }}

          [api]
          central_api_url = {{ central_api_url }}

          [hardware]
          hardware_type = {{ hardware_type | default('generic') }}
          simulation_mode = {{ simulation_mode | default('false') }}
          gpio_enabled = {{ 'true' if hardware_type | default('generic') != 'simulator' else 'false' }}

          [logging]
          level = {{ log_level | default('INFO') }}
          file = /app/logs/edge-controller.log
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      notify: restart edge controller

    # ========================================================================
    # Log in to Docker Registry
    # ========================================================================

    - name: Log in to GHCR
      docker_login:
        registry: "{{ docker_registry }}"
        username: "{{ docker_registry_username }}"
        password: "{{ docker_registry_password }}"
      when: docker_registry_username is defined
      tags: update

    # ========================================================================
    # Pull Latest Image
    # ========================================================================

    - name: Pull edge controller image
      docker_image:
        name: "{{ edge_controller_image }}"
        tag: "{{ edge_controller_tag }}"
        source: pull
        force_source: yes
      register: pull_result
      tags: update

    - name: Check if image was updated
      set_fact:
        image_updated: "{{ pull_result.changed }}"
      tags: update

    # ========================================================================
    # Stop Existing Container (if exists)
    # ========================================================================

    - name: Stop existing edge controller
      docker_container:
        name: "{{ edge_container_name }}"
        state: stopped
      failed_when: false
      when: image_updated or force_restart | default(false)

    - name: Remove existing edge controller
      docker_container:
        name: "{{ edge_container_name }}"
        state: absent
      failed_when: false
      when: image_updated or force_restart | default(false)

    # ========================================================================
    # Deploy Edge Controller Container
    # ========================================================================

    - name: Deploy edge controller container
      docker_container:
        name: "{{ edge_container_name }}"
        image: "{{ edge_image_full }}"
        state: started
        restart_policy: unless-stopped

        # Privileged mode for GPIO access (required for stepper_hat and generic)
        privileged: "{{ hardware_type | default('generic') != 'simulator' }}"

        # Device mapping for GPIO
        devices: "{{ ['/dev/gpiomem:/dev/gpiomem'] if hardware_type | default('generic') != 'simulator' else [] }}"

        # Volumes
        volumes:
          - /opt/train-control/config:/app/config:ro
          - /opt/train-control/logs:/app/logs
          - /var/lib/train-control:/app/data

        # Environment variables
        env:
          TRAIN_ID: "{{ train_id }}"
          HARDWARE_TYPE: "{{ hardware_type | default('generic') }}"
          MQTT_BROKER: "{{ mqtt_broker }}"
          MQTT_PORT: "{{ mqtt_port }}"
          MQTT_USERNAME: "{{ mqtt_username }}"
          MQTT_PASSWORD: "{{ mqtt_password }}"
          CENTRAL_API_URL: "{{ central_api_url }}"
          LOG_LEVEL: "{{ log_level | default('INFO') }}"
          SIMULATION_MODE: "{{ simulation_mode | default('false') }}"

        # Health check
        healthcheck:
          test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
          interval: 30s
          timeout: 5s
          retries: 3
          start_period: 10s

        # Labels
        labels:
          train_id: "{{ train_id }}"
          component: edge-controller
          managed_by: ansible
      register: container_result

    # ========================================================================
    # Validation
    # ========================================================================

    - name: Wait for container to be healthy
      command: docker inspect --format='{{.State.Health.Status}}' {{ edge_container_name }}
      register: health_check
      until: health_check.stdout == 'healthy'
      retries: 10
      delay: 3
      changed_when: false
      failed_when: false

    - name: Get container logs (last 20 lines)
      command: docker logs --tail 20 {{ edge_container_name }}
      register: container_logs
      changed_when: false

    - name: Show container status
      command: docker ps -f name={{ edge_container_name }} --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
      register: container_status
      changed_when: false

    # ========================================================================
    # Deployment Summary
    # ========================================================================

    - name: Show deployment summary
      debug:
        msg:
          - "âœ… Edge controller deployed successfully!"
          - ""
          - "Device: {{ inventory_hostname }}"
          - "Train ID: {{ train_id }}"
          - "Train Name: {{ train_name }}"
          - "Container: {{ edge_container_name }}"
          - "Image: {{ edge_image_full }}"
          - "MQTT Broker: {{ mqtt_broker }}:{{ mqtt_port }}"
          - "Central API: {{ central_api_url }}"
          - "Simulation Mode: {{ simulation_mode | default('false') }}"
          - ""
          - "Container Status:"
          - "{{ container_status.stdout }}"
          - ""
          - "Recent Logs:"
          - "{{ container_logs.stdout_lines[-10:] | join('\n') }}"
          - ""
          - "Next steps:"
          - "1. Monitor logs: docker logs -f {{ edge_container_name }}"
          - "2. Check MQTT: Subscribe to trains/{{ train_id }}/status"
          - "3. Send command: Publish to trains/{{ train_id }}/commands"

  handlers:
    - name: restart edge controller
      docker_container:
        name: "{{ edge_container_name }}"
        state: started
        restart: yes
      when: container_result is defined and not container_result.changed

  post_tasks:
    - name: Save deployment metadata
      copy:
        dest: /opt/train-control/.deployed
        content: |
          Train ID: {{ train_id }}
          Train Name: {{ train_name }}
          Deployed: {{ ansible_date_time.iso8601 }}
          Image: {{ edge_image_full }}
          MQTT Broker: {{ mqtt_broker }}
          Central API: {{ central_api_url }}
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
